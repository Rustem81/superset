version: '3.8'

services:
  postgres:
    image: postgres:15.2-alpine
    container_name: postgres-chinook
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: admin
      POSTGRES_DB: chinook_serial
      POSTGRES_HOST_AUTH_METHOD: trust # üîì –ù–∏–∫–∞–∫–∏—Ö –ø–∞—Ä–æ–ª–µ–π, —Ç–æ–ª—å–∫–æ –¥–æ–≤–µ—Ä–∏–µ
      LANG: en_US.utf8
      LC_ALL: en_US.utf8
    volumes:
      - pg_data_chinook2:/var/lib/postgresql/data
      - ./Chinook_PostgreSql_SerialPKs.sql:/docker-entrypoint-initdb.d/init.sql
      # üî• –î–µ–ª–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –¥–ª—è –∑–∞–ø–∏—Å–∏ —Å —Ö–æ—Å—Ç–∞
      - ./init_data_done:/init_data_done # –§–ª–∞–≥, —á—Ç–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞
    ports:
      - '25432:5432'
    networks:
      - superset_net
    restart: unless-stopped
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U admin -d chinook_serial']
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s

  superset:
    build: .
    container_name: superset-app
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - '8088:8088'
    environment:
      SUPERSET_SECRET_KEY: A0Zr98j/3yX R~XHH!jmN]LWX/,?RT
      DATABASE_URL: postgresql://admin:admin@postgres:5432/chinook_serial
      WTF_CSRF_ENABLED: 'False'
      FLASK_APP: superset.app:create_app
      PIP_ROOT_USER_ACTION: ignore
      SUPERSET_CONFIG_PATH: /app/superset_config.py
      # üî• –û—Ç–∫–ª—é—á–∞–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ, –≤–∫–ª—é—á–∞–µ–º debug (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      FLASK_ENV: development
    volumes:
      # üî• –ú–æ–Ω—Ç–∏—Ä—É–µ–º —Å –ø–æ–ª–Ω—ã–º –¥–æ—Å—Ç—É–ø–æ–º
      - ./superset_data:/app/superset_home:rw # superset.db, –∫—ç—à, –ª–æ–≥–∏
      - ./superset_config.py:/app/superset_config.py:ro
      # üî• –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å
      - ./chmod-fix.sh:/chmod-fix.sh
    networks:
      - superset_net
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8088/health']
      interval: 10s
      timeout: 5s
      retries: 30
    command: >
      bash -c "
        # –ó–∞–ø—É—Å–∫–∞–µ–º fix-–ø—Ä–∞–≤ –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞
        chmod -R 777 /app/superset_home || true &&
        superset db upgrade &&
        superset fab create-admin --username admin --firstname Admin --lastname User --email admin@superset.com --password admin &&
        superset init &&
        # –ï—â—ë —Ä–∞–∑ –Ω–∞ –≤—Å—è–∫–∏–π
        chmod -R 777 /app/superset_home || true &&
        superset run -h 0.0.0.0 -p 8088"

networks:
  superset_net:
    driver: bridge

volumes:
  pg_data_chinook2:
    driver: local

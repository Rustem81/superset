FROM apache/superset:latest

# –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ root
USER root

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        gcc \
        python3-dev \
        libpq-dev \
        build-essential && \
    rm -rf /var/lib/apt/lists/*

# –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ pip —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏
# –ü—Ä–æ–≤–µ—Ä–∏–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ /app/.venv/bin/pip
RUN if [ -f /app/.venv/bin/pip ]; then \
      echo "‚úÖ pip —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ /app/.venv/bin/pip"; \
    else \
      echo "üîß pip –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–µ—Ä–µ–∑ ensurepip..."; \
      python -m ensurepip --upgrade || echo "‚ö†Ô∏è ensurepip –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –ø—Ä–æ–±—É–µ–º –≤—Ä—É—á–Ω—É—é"; \
    fi

# –î–∞–∂–µ –µ—Å–ª–∏ ensurepip –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª ‚Äî –ø–æ–ø—Ä–æ–±—É–µ–º —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ python -m pip
# –ò–ª–∏ —á–µ—Ä–µ–∑ /usr/local/bin/python -m pip
RUN python -m pip install psycopg2-binary --no-cache-dir --force-reinstall || \
    /usr/local/bin/python -m pip install psycopg2-binary --no-cache-dir --force-reinstall

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–æ–¥—É–ª—å –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è
RUN python -c "import psycopg2; print('üéâ psycopg2 —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω!')"

# –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é superset
USER superset